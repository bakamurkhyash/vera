<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERA: Developer Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* CSS Reset and Variables (Same as homepage) */
        :root {
            --dark: #0f0f1a;
            --primary: #6e45e2; /* Purple */
            --accent: #b06ab3; /* Pink/Magenta */
            --text-light: #f0f0f5;
            --text-muted: #b0b0c5;
            --transition: all 0.3s ease;
            --card-bg: rgba(30, 30, 46, 0.7);
            --border-color: rgba(110, 69, 226, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Utility Class for Hiding Content (FIX IMPLEMENTATION) */
        .hidden {
            display: none !important;
        }
        /* Dashboard Specific Styles */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            padding-top: 6rem; /* Space for the fixed header */
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background: #1a1a2e;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 999;
            padding-top: 80px;
        }

        .sidebar h3 {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 1.5rem;
        }

        .sidebar a {
            display: block;
            color: var(--text-muted);
            text-decoration: none;
            padding: 12px 0;
            margin: 5px 0;
            border-left: 3px solid transparent;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer; /* Indicate clickability */
        }

        .sidebar a i {
            margin-right: 10px;
        }

        .sidebar a.active {
            color: var(--text-light);
            border-left: 3px solid var(--accent);
            background-color: rgba(110, 69, 226, 0.1);
        }
        .sidebar a:hover:not(.active) {
            color: white;
        }

        /* Main Content Styling */
        .main-content {
            flex-grow: 1;
            margin-left: 250px; /* Offset for fixed sidebar */
        }

        /* Content Panel Styling (The direct child of main-content that gets toggled) */
        .content-panel {
            padding: 30px;
        }

        .content-panel h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        /* Dashboard Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .metric-card h4 {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .metric-card .value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent);
            display: block;
        }

        .metric-card .change {
            font-size: 0.9rem;
            color: #4CAF50; /* Green for positive */
            margin-top: 5px;
        }

        /* API Usage Chart */
        .chart-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            max-height: 400px;
            position: relative;
        }

        .chart-panel h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        #usageChart {
            height: 300px; 
            width: 100%;
        }
        
        /* API Key Management (Now inside api-content panel) */
        .api-key-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .api-key-panel h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .key-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f0f1a;
            border: 1px dashed var(--primary);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .key-display code {
            color: var(--text-light);
            font-family: monospace;
            overflow-wrap: break-word;
            word-break: break-all;
            flex-grow: 1;
            margin-right: 15px;
            font-size: 1rem;
        }

        .key-action-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .key-action-button:hover {
            opacity: 0.8;
        }

        .key-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 15px;
        }
        
        /* Billing Section Styling */
        .billing-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .billing-card p strong {
            color: var(--accent);
        }

        /* Header Styling (To replace fixed nav bar on dashboard) */
        .dashboard-header {
            position: fixed;
            top: 0;
            width: 100%;
            height: 60px;
            background: #1a1a2e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 30px;
        }

        .dashboard-logo {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            letter-spacing: 2px;
            position: absolute;
            left: 20px;
            top: 15px;
        }

        .user-profile a {
            color: var(--text-light);
            text-decoration: none;
            margin-left: 20px;
            transition: color 0.3s;
        }

        .user-profile a:hover {
            color: var(--accent);
        }

        /* Footer (Simple dashboard footer) */
        .dashboard-footer {
            background-color: #1a1a2e;
            color: var(--text-muted);
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
            margin-left: 250px;
            width: calc(100% - 250px);
            border-top: 1px solid rgba(110, 69, 226, 0.1);
            position: fixed;
            bottom: 0;
        }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div class="dashboard-logo">VERA</div>
        <div class="user-profile">
            <a href="#"><i class="fas fa-bell"></i> Notifications</a>
            <a href="#"><i class="fas fa-user-circle"></i> {{ current_user.name }}</a>
            <a href={{ url_for("login") }}><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>
    
    <div class="dashboard-container">
        <div class="sidebar">
            <h3>Developer Portal</h3>
            <a data-target="dashboard-content" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a data-target="api-content" class="nav-link"><i class="fas fa-code"></i> API Reference</a>
            <a data-target="key-content" class="nav-link"><i class="fas fa-key"></i> Key Management</a>
            <a data-target="billing-content" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Billing & Usage</a>
            <a data-target="settings-content" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
        </div>

        <div class="main-content">
            
            <div id="dashboard-content" class="content-panel">
                <h1>API Analytics & Usage Overview</h1>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h4>Total Try-Ons (MTD)</h4>
                        <span class="value">45,890</span>
                        <span class="change text-success"><i class="fas fa-arrow-up"></i> 12% vs last month</span>
                    </div>
                    <div class="metric-card">
                        <h4>Average Latency (ms)</h4>
                        <span class="value">185 ms</span>
                        <span class="change" style="color: #FFC107;"><i class="fas fa-arrow-down"></i> 3% vs last month</span>
                    </div>
                    <div class="metric-card">
                        <h4>Successful Requests</h4>
                        <span class="value">99.8%</span>
                        <span class="change text-success"><i class="fas fa-check-circle"></i> Normal</span>
                    </div>
                    <div class="metric-card">
                        <h4>Current Tier Usage</h4>
                        <span class="value">$458.90</span>
                        <span class="change" style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> 55% of limit</span>
                    </div>
                </div>

                <div class="chart-panel">
                    <h3>Try-On Requests (Last 7 Days)</h3>
                    <canvas id="usageChart"></canvas>
                </div>
            </div>

            <div id="api-content" class="content-panel hidden">
                <h1>API Reference & Documentation</h1>
                <div class="api-key-panel">
                    <h3>VERA API Endpoints</h3>
                    <p>Refer to our official documentation for detailed request and response schemas.</p>
                    <ul>
                        <li><i class="fas fa-link"></i> **POST /v1/tryon**: Primary endpoint for generating virtual try-on images.</li>
                        <li><i class="fas fa-link"></i> **GET /v1/status/{job_id}**: Check the status of an asynchronous job.</li>
                        <li><i class="fas fa-link"></i> **GET /v1/products**: Retrieve metadata for uploaded product catalogs.</li>
                    </ul>
                </div>
            </div>

            <div id="key-content" class="content-panel hidden">
                <h1>API Key Management</h1>
                <div class="api-key-panel">
                    <h3>Primary VERA API Key</h3>
                    <p>Use this key for all authentication against the VERA API endpoints.</p>

                    <div class="key-display">
                        <code>sk_vera_a8f9c1b7d4e2f6a8b3c0d9e2f4a7b0c3d6e9f2a4b8c1d3e5f7a0b2c4d9e1f3a6</code>
                        <button class="key-action-button" onclick="copyKey()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="key-action-buttons">
                        <button class="secondary-button" style="margin-right: 15px;"><i class="fas fa-sync-alt"></i> Rotate Key</button>
                        <button class="secondary-button" style="background-color: #dc3545;"><i class="fas fa-trash-alt"></i> Revoke Key</button>
                    </div>
                    <p class="key-description">**Warning:** Rotating your key will immediately invalidate the current key. Update all running applications.</p>
                </div>
            </div>
            
            <div id="billing-content" class="content-panel hidden">
                <h1>Billing & Usage History</h1>
                <div class="billing-card">
                    <h3>Current Billing Cycle (Dec 1 - Dec 31)</h3>
                    <p>Total Usage: **45,890** Try-Ons</p>
                    <p>Estimated Charge: **$458.90 USD**</p>
                    <p>Payment Method: Visa ending in 4242</p>
                    <p>Next Invoice Date: **Jan 1, 2026**</p>
                </div>
            </div>

            <div id="settings-content" class="content-panel hidden">
                <h1>Account Settings</h1>
                <div class="billing-card">
                    <h3>Notification Preferences</h3>
                    <p>Email alerts for usage limits are **Enabled**.</p>
                    <p>Service outage notifications via SMS are **Disabled**.</p>
                </div>
            </div>

        </div>
    </div>
    
    <div class="dashboard-footer">
        &copy; 2025 VERA Developer Portal. All rights reserved.
    </div>

    <script>
        // --- Tab Navigation Logic (FIX IMPLEMENTATION) ---

        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const contentPanels = document.querySelectorAll('.content-panel');

            // Function to handle tab switching
            function showTab(targetId, clickedLink) {
                // 1. Hide all content panels
                contentPanels.forEach(panel => {
                    panel.classList.add('hidden');
                });

                // 2. Deactivate all navigation links
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });

                // 3. Show the targeted panel
                const targetPanel = document.getElementById(targetId);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }

                // 4. Activate the clicked link
                clickedLink.classList.add('active');
                
                // Special case: If switching back to dashboard, reinitialize chart
                if (targetId === 'dashboard-content' && !usageChart) {
                    initializeChart();
                }
            }

            // Add click listeners to sidebar links
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const targetId = link.getAttribute('data-target');
                    showTab(targetId, link);
                });
            });

            // Ensure only the default tab is visible on load
            // Since 'dashboard-content' is the default, no extra hiding is needed 
            // beyond the CSS .hidden class applied to the others.
        });


        // --- Chart & Dynamic Logic (from previous steps) ---
        
        let usageChart = null; // Changed to null to indicate uninitialized state
        const API_ENDPOINT = '/api/usage/last-7-days'; 

        // Data Fetch function using the Flask API
        async function fetchNewDataFromAPI() {
            try {
                // In a Flask environment, this should correctly hit the /api/usage/last-7-days endpoint
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.data; 
            } catch (error) {
                console.error("Could not fetch usage data:", error);
                return []; 
            }
        }

        // Chart Update Logic
        async function updateChartData() {
            if (usageChart) {
                const latestData = await fetchNewDataFromAPI();
                if (latestData.length > 0) {
                    usageChart.data.datasets[0].data = latestData;
                    usageChart.update(); 
                }
            }
        }
        
        // Chart Initialization function (can be called again if needed)
        function initializeChart() {
             const data = {
                labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                datasets: [{
                    label: 'Virtual Try-Ons',
                    data: [0, 0, 0, 0, 0, 0, 0], // Initial data will be replaced by API call
                    backgroundColor: 'rgba(176, 106, 179, 0.2)',
                    borderColor: 'var(--accent)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            };

            const ctx = document.getElementById('usageChart').getContext('2d');
            usageChart = new Chart(ctx, config);

            // Run the first update immediately, then set the interval
            updateChartData(); 
            // Store the interval ID so it can be cleared if navigation was complex
            // For this simple design, we let it run constantly.
            setInterval(updateChartData, 5000); 
        }

        // Run the initialization sequence on page load
        document.addEventListener('DOMContentLoaded', initializeChart);
        
        // Function to copy API key (kept for completeness)
        function copyKey() {
            const keyElement = document.querySelector('.key-display code');
            navigator.clipboard.writeText(keyElement.textContent);
            
            const button = document.querySelector('.key-action-button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 1500);
        }
    </script>
</body>
</html>